# Active Directory

## The Basics

A maior parte das companhias se sentem confortáveis ao usarem o AD por ser um diretório que controla e monitora os computadores dos seus usuário em um só **domain controller**.
Ele serve para que um usuário na mesma rede do AD consiga ter acesso a diferentes servidores sem que seja preciso configurar um usuário novo para cada um deles.

## Physical Active Directory

São os servidores que servem para fornecer tudo que o AD precisa além do software.

### Domain Controller

É um **windows server** que tem o **Active Directory Domain Services(AD DS)** instalado e foi promovido à domain controller na floresta(de diretórios).
Domain Controllers são o centro do Active Directory, eles controlam o resto do domínio, é papel dele :

1. Armazenar o AD DS data store
2. Lidar com os serviços de autenticação e autorização
3. Replicar as atualizações para outros Domain Controllers na floresta
4. Permitir que os administradores gerenciem os recursos dos domínios

### Active Directory Domain Services(AD DS) Data Store

O Active Directory Data Store mantém os bancos de dados dos processos necessários por armazenar e manter as informações de diretório como users, groups e serviços. Abaixo estão algumas características do AD DS Data Store :

1. Contém o **NTDS.dit** - um banco de dados que contém toda a informação do AD domain controller e também as senhas e hashes dos domain users.
2. É armazenado por padrão no **%SystemRoot%\NTDS**
3. Acessável apenas pelo domain controller

## The Forest

São as conexões entre os domínios e as arvores que estão na rede. É o que torna todo o sistema capaz de interagir. Uma Floresta é uma coleção de um ou mais árvores de domínio dentro da rede do AD, algumas características da Floresta são :

1. **Árvores** : Uma hirarquia de domínios dentro do Active Directory Domain Services
2. **Domínios** : Usado para agrupar e gerenciar objetos
3. **Organizational Units(OUs)** : Containers para grupos, computadores, usuários, impressoras e outros OUs
4. **Trusts** : Permite que usuários acessem recursos em outros domínios
5. **Domain Services** : DNS Server, LLMNR, IPv6
6. **Domain Schema** : Regras para criação de objetos

## Users + Groups

Quando se cria um Domain Controller, ele vem com dois usuários : **Administrator e guest**. Cabe a você criar novos usuários e grupos

### Users

Existem 4 tipos de usuários com permissões diferentes :

1. **Domain Admin** : O boss, o cara que controla os domínios e são os únicos com acesso ao domain controller.
2. **Contas de Serviço(podem ser Domain Admins)** : Essas contas na maior parte das vezes servem para manuntenção de um serviço e quase nunca são usadas. Elas são requeridas pelo Windows para serviços como SQL para parear um serviço a uma Conta de Serviço.
3. **Local Administrator** : Esses usuários podem realizar mudanças na máquina local e podem ser capazer de controlar outros usuários normais. Mas eles **não podem acessar o domain controller**.
4. **Domain Users** : Esses são os usuários do dia a dia. 

### Grupos

Existem dois tipos de grupos no AD :

1. **Security Groups** : São os grupos usados para especificar permissões para um grande número de usuários
2. **Distribution Groups** : Esses grupos são usados para especificar listas de distribuição de emails. Como um atacante, esses grupos nos beneficiariam menos, mas ainda seriam úteis em enumeration.

### Default Security Groups

1. Domain Controllers - All domain controllers in the domain
2. Domain Guests - All domain guests
3. Domain Users - All domain users
4. Domain Computers - All workstations and servers joined to the domain
5. Domain Admins - Designated administrators of the domain
6. Enterprise Admins - Designated administrators of the enterprise
7. Schema Admins - Designated administrators of the schema
8. DNS Admins - DNS Administrators Group
9. DNS Update Proxy - DNS clients who are permitted to perform dynamic updates on behalf of some other clients (such as DHCP servers).
10. Allowed RODC Password Replication Group - Members in this group can have their passwords replicated to all read-only domain controllers in the domain
11. Group Policy Creator Owners - Members in this group can modify group policy for the domain
12. Denied RODC Password Replication Group - Members in this group cannot have their passwords replicated to any read-only domain controllers in the domain
13. Protected Users - Members of this group are afforded additional protections against authentication security threats. See http://go.microsoft.com/fwlink/?LinkId=298939 for more information.
14. Cert Publishers - Members of this group are permitted to publish certificates to the directory
15. Read-Only Domain Controllers - Members of this group are Read-Only Domain Controllers in the domain
16. Enterprise Read-Only Domain Controllers - Members of this group are Read-Only Domain Controllers in the enterprise
17. Key Admins - Members of this group can perform administrative actions on key objects within the domain.
18. Enterprise Key Admins - Members of this group can perform administrative actions on key objects within the forest.
19. Cloneable Domain Controllers - Members of this group that are domain controllers may be cloned.
20. RAS and IAS Servers - Servers in this group can access remote access properties of users

## Trusts and Policies

Trusts and Policies são os mecanismos que permitem que as trees se comuniquem entre si de forma que a segurança da rede seja mantida.

### Domain Trusts

Trusts são o mecanismo que permite que usuários da rede tenham acesso a outros recursos do domínio. Em outras palavras, eles traçam o caminho que domínios dentro de uma floresta se comuniquem uns com os outros.

Existem dois tipos de Trusts :

1. **Directional** : A direção de confiança vai sempre de um domínio para outros
2. **Transitive** : A relação de confiança se expande para além de apenas dois domínios.

O tipo de confiança definie como os domínios e árvores na floresta são capazes de se comunicar. **Abusando dessas confianças podemos nos mover lateralmente na rede**

### Domain Policies

If you wanted to disable windows defender across all machines on the domain you could create a new group policy object to disable Windows Defender. The options for domain policies are almost endless and are a big factor for attackers when enumerating an Active Directory network. I'll outline just a few of the  many policies that are default or you can create in an Active Directory environment: 

1. Disable Windows Defender - Disables windows defender across all machine on the domain
2. Digitally Sign Communication (Always) - Can disable or enable SMB signing on the domain controller

## AD DS and Authentication

### Domain Services

São os serviçoes que o Domain Controller provê para o resto dos domínios ou trees. Os default domain services são :

1. LDAP - Lightweight Directory Access Protocol; provides communication between applications and directory services
2. Certificate Services - allows the domain controller to create, validate, and revoke public key certificates
3. DNS, LLMNR, NBT-NS - Domain Name Services for identifying IP hostnames

### Domain Authentication Services

Essa é a parte mais importante, bem como a mais vulnerável, do Active Directory. Existem dois tipos de autenticação no active directory :

1. **Kerberos** - The default authentication service for Active Directory uses ticket-granting tickets and service tickets to authenticate users and give users access to other resources across the domain.
2. **NTLM** - default Windows authentication protocol uses an encrypted challenge/response protocol

## AD na Nuvem

O mais notável provedor de AD de nuvem é o Azure AD, ele atua como um intermediário entre os computadores dos usuários e o seu Active Diretory On-Premise. Isso torna o ambiente mais seguro e torna ineficaz boa parte dos ataquies.

O Azure AD utiliza respectivamente Rest APIs, OAuth/SAML e OpenID ao invés de LDAP, NTLM e Kerberos.

# Comandos

Utilizando PowerView

1. Get a list of all operating systems on the domain
`Get-NetComputer -fulldata | select operatingsystem`

2. Get a list of all users on the domain
`Get-NetUser | select cn`

