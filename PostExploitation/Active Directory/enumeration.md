# Enumerating

Enumeration começa a partir do ponto que temos um par de credenciais.

**SYSVOL** is the network folder on a domain controller is accessible by any authenticated AD account and stores GPO information

## Credential Injection

### Runas

Runas é um **native binary** e serve para quando temos um par de credencial mas não sabemos onde nos logar. O Runas vai injetar as credenciais na memória para que a partir de uma máquina windows, consigamos nos logar no AD

`runas.exe /netonly /user:<domain>\<username> cmd.exe`

1. **/netonly** : Porque queremos nos autenticr na rede do AD, mas não diretamente no Domain Controller

2. **/user** : Aqui fornecemos o usuário em FQDN e não apenas o nome do usuário como consta na NetBIOS

3. **cmd.exe** : O programa que queremos que seja executado quando as credenciais forem injetadas.

### IP vs Hostnames

**Question**: *Is there a difference between dir \\za.tryhackme.com\SYSVOL and dir \\<DC IP>\SYSVOL and why the big fuss about DNS?*

There is quite a difference, and it boils down to the authentication method being used. When we provide the hostname, network authentication will attempt first to perform Kerberos authentication. **Since Kerberos authentication uses hostnames embedded in the tickets, if we provide the IP instead, we can force the authentication type to be NTLM**. While on the surface, this does not matter to us right now, it is good to understand these slight differences since they can allow you to remain more stealthy during a Red team assessment. In some instances, organisations will be monitoring for OverPass- and Pass-The-Hash Attacks. Forcing NTLM authentication is a good trick to have in the book to avoid detection in these cases.

## Microsoft Management Console


## Prós
1. The GUI provides an excellent method to gain a holistic view of the AD environment.
2. Rapid searching of different AD objects can be performed.
3. It provides a direct method to view specific updates of AD objects.
4. If we have sufficient privileges, we can directly update existing AD objects or add new ones
## Contras
5. The GUI requires RDP access to the machine where it is executed.
6. Although searching for an object is fast, gathering AD wide properties or attributes cannot be performed.

## Enumerating with CMD

Podemmos utilizar o comando Net para fazer enumeration do AD. The net commands must be executed from a domain-joined machine. If the machine is not domain-joined, it will default to the WORKGROUP domain. The net commands may not show all information. For example, if a user is a member of more than ten groups, not all of these groups will be shown in the output

1. Listar todos os usuários do domínio
`net user /domain`

2. Retornar informações de um usuário do domínio
`net user zoe.marshall /domain`

3. Listar os grupos de um domínio
`net group /domain`

4. Retornar informações de um grupo do domínio
`net group "Tier 1 Admins" /domain`

5. Enumerar password-policy
`net accounts /domain`

Enumerar a política de senhas pode ser bom pois :
1. Length of password history kept. Meaning how many unique passwords must the user provide before they can reuse an old password.
2. The lockout threshold for incorrect password attempts and for how long the account will be locked.
3. The minimum length of the password.
4. The maximum age that passwords are allowed to reach indicating if passwords have to be rotated at a regular interval.

## Enumerating With Power Shell

**We have to install the AD-RSAT tooling or use other, potentially detectable, scripts for PowerShell enumeration.**

Utilizando o módulo **AD-RSAT** para enumerar com PowerShell

1. Select em Usuário
`PS C:\> Get-ADUser -Identity gordon.stevens -Server za.tryhackme.com -Properties *`
2. Select em Usuário com wildcard
`PS C:\> Get-ADUser -Filter 'Name -like "*stevens"' -Server za.tryhackme.com | Format-Table Name,SamAccountName -A`
3. Select em Grupo
`PS C:\> Get-ADGroup -Identity Administrators -Server za.tryhackme.com`
4. Select em Usuários do Grupo
`PS C:\> Get-ADGroupMember -Identity Administrators -Server za.tryhackme.com`
5. Ver usuários que mudaram senha antes dessa data
`PS C:\> $ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)`
`PS C:\> Get-ADObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObjects -Server za.tryhackme.com`
6. Ver informações de um domínio específico
`PS C:\> Get-ADDomain -Server za.tryhackme.com`
7. Alterando objetos do AD
`PS C:\> Set-ADAccountPassword -Identity gordon.stevens -Server za.tryhackme.com -OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "new" -Force)`

### Password Spraying Básico com PS

Se quisermos performar um password Spraying sem bloquear contas, podemos utilizar enumeração para saber quais contas tem "badPwdCount" maior que zero para evitar colocar essas contas em nossa lista.

`PS C:\> Get-ADObject -Filter 'badPwdCount -gt 0' -Server za.tryhackme.com`

## Bloodhound

A estratégia de utilizar o BloodHound é fazer uma enumeração de dados com o SharpHound para em seguida utilizar esses dados e processá-los offline com o BloodHound. Isso é feito pois é detectável pelo Blue Team quando um usuário faz uma enumeração dos dados via SharpHound. Passando para o offline, podemos fazer toda a simulação do Ataque Offline para que na segunda campanha de Phishing adentremos o servidor e utilizemos as brechas já descobertas para atacar o sistema.

### Sharphound

É a ferramenta de enumeration do BloodHound que pode ser encontrada nos seguintes formatos :

1. Sharphound.ps1 - PowerShell script for running Sharphound. However, the latest release of Sharphound has stopped releasing the Powershell script version. This version is good to use with RATs since the script can be loaded directly into memory, evading on-disk AV scans.
2. Sharphound.exe - A Windows executable version for running Sharphound.
3. AzureHound.ps1 - PowerShell script for running Sharphound for Azure (Microsoft Cloud Computing Services) instances. Bloodhound can ingest data enumerated from Azure to find attack paths related to the configuration of Azure Identity and Access Management.

When using these on an assessment, there is a **high likelihood that these files will be detected as malware and raise an alert to the blue team**. This is again where our Windows machine that is non-domain-joined can assist. We can use the runas command to inject the AD credentials and point Sharphound to a Domain Controller. Since we control this Windows machine, we **can either disable the AV or create exceptions for specific files or folders**. We will execute Sharphound as follows:

`Sharphound.exe --CollectionMethods <Methods> --Domain za.tryhackme.com --ExcludeDCs`

Parameters explained:

1. CollectionMethods - Determines what kind of data Sharphound would collect. The most common options are Default or All. Also, since Sharphound caches information, once the first run has been completed, you can only use the Session collection method to retrieve new user sessions to speed up the process.
2. Domain - Here, we specify the domain we want to enumerate. In some instances, you may want to enumerate a parent or other domain that has trust with your existing domain. You can tell Sharphound which domain should be enumerated by altering this parameter.
3. ExcludeDCs -This will instruct Sharphound not to touch domain controllers, which reduces the likelihood that the Sharphound run will raise an alert.

https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html

It will take about 1 minute for Sharphound to perform the enumeration. In larger organisations, this can take quite a bit longer, even hours to execute for the first time. Once completed, you will have a timestamped ZIP file in the same folder you executed Sharphound from. We can now use Bloodhound to ingest this ZIP to show us attack paths visually.

### Bloodhound

As mentioned before, Bloodhound is the GUI that allows us to import data captured by Sharphound and visualise it into attack paths. Bloodhound uses Neo4j as its backend database and graphing system. Neo4j is a graph database management system

`neo4j console start`

Iniciando o neo4j na nossa máquina e depois de copiar o arquivo de grafo do AD que criamos com o Sharphound, podemos copiá-lo 
`scp <AD Username>@THMJMP1.za.tryhackme.com:C:/Users/<AD Username>/Documents/<Sharphound ZIP> .`

