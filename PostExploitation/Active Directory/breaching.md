# Breaching

Antes que possamos exploitar misconfigurations no AD para escalar privilégios, precisamos ter o acesso inicial a partir de um par de credenciais válido ao AD.


## NTLM

NTLM é a tecnologia de protocolos de segurança usado para autenticar usuários no AD. Ele pode ser utilizado para se autenticar no AD utilizando um esquema de resposta baseada em desafio chamado NetNTLM.

O esquema é o seguinte : Quando um usuário quer se conectar a um servidor, como o Domain Controller é quem fornece os acessos nos domínios, ele compara o desafio dado pelo servidor com a resposta do usuário, caso positivo, ele comunica ao servidor que permita a conexão. Assim, o papel do servidor na autenticação é apenas encaminhar as mensagens e não validar nada.

Algumas aplicações podem ter o serviço de autenticação do NTLM exposto numa url como ntlmauth.za.tryhackme.com . No caso de tentar burlar um servidor que use NTLM com bruteforce, é sugerido utilizarmos password spraying para evitar a detecção por parte do sistema.

## LDAP

Outro método de autenticação no AD que aplicações podem utilizar é o LDAP. O LDAP funciona de maneira que o serviço receba o par de credenciais do usuário, cria uma comunicação com o DC utilizando as próprias credenciais de AD do serviço, envia o par de credenciais do usuário ao DC para checagem e depois crie um Bind entre o serviço e o usuário a partir do DC.

Por existir a necessidade do serviço criar um Bind com o DC utilizando as próprias credenciais, muitas vezes estas são achadas em arquivos de configuração no host.

### LDAP Pass-back Attacks

Esse ataque pode ser feito ganhando acesso inicial à rede interna, como por exemplo plugando um rogue device. Tem as seguintes etapas :

1. Se acessa um dispositivo na rede como uma impressora. Não conseguiremos ter acesso às senhas que os usuários do AD enviam por LDAP, pois geralmente estão escondidas
2. Mudamos o IP do LDAP server para o do nosso rogue device
3. Fazemos o Downgrade do LDAP server do nosso rogue device para aceitar apenas comunicaçãoes de LDAP em plaintext
4. Conseguimos credenciais

### Hosting a Rogue LDAP Server

1. `sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd`

## Authentication Relays

Nesta seção iremos focar em NetNTLM usado pelo SMB. Vamos focar em dois exploits diferentes:
1. Visto que NTLM Challenges podem ser interceptados, utilizaremos técnicas de cracking de forma offline para recuperar a senha associada ao NTLM challenge.
2. Podemos utilizar nosso Rogue Device como um MITM para nos autenticar ao servidor alvo.

https://github.com/lgandx/Responder -> tool we can use to poison and capture authentication requests on the network

## Microsoft Deployment Toolkit(MDT)

**MDT é um serviço da Microsoft que auxilia no deploy de Sistemas Operacionais da Microsoft**. Grandes organizações utilizam o MDT para auxiliar no deploy de novas imagens de OS de forma mais rápida. 

Geralmente o MDT é integrado com o **System Center Configuration Manager(SCCM)**, que é o software que gerencia todos os updates das aplicações microsoft.

Como o MDT e o SCCM são ferramentas que controlam softwares em larga escala, ela é alvo desejado de hackers.

O MDT pode ser configurado de várias maneiras, aqui focaremos em falar da **PXE BOOT**

### PXE Boot

PXE Boot é uma configuração que permite que um usuário consiga instalar uma imagem de sistema operacional a partir da rede. Esse serviço está geralmente integrado com o DHCP, pois o OS só consegue ser instalado depois que um IP é assegurada para a máquina. **Existem dois principais propósitos para se fazer um exploit de uma imagem de PXE boot**:

1. Injetar um vetor de escalação de privilégios para ganhar acesso administrativo ao Sistema Operacionais assim que o PXE boot estiver completo.
2. Performar um password scrapping attack para recuperar credenciais do AD usadas durante a instalação.

Para ler os conteúdos da PXEBoot é recomendado usar o PowerPXE

https://github.com/wavestone-cdt/powerpxe

## Configuration Files

Existem diversos Scripts de enumeração de arquivos de configuração em AD, como o Seatbelt

https://github.com/GhostPack/Seatbelt



