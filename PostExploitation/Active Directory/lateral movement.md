# Lateral Movement and Pivoting

# Spawnando Processos Remotamente

## Psexec

It allows an administrator user to run commands remotely on any PC where he has access. Psexec is one of many Sysinternals Tools e pode ser baixada aqui : https://docs.microsoft.com/en-us/sysinternals/downloads/psexec
**Porta 445/TCP** : (SMB) - **Required Group Memberships** : Administrators

A maneira que o Psexec funciona pode ser vista a seguir :

1. Conecte-se à Admin$ Share e faça upload do binário do Psexec. Psexec usa **psexesvc.exe** como nome
2. Se conecte ao service control manager para criar e rodar um serviço com nome PSEXESVC e associá-lo ao binário `C:\Windows\psexesvc.exe`
3. Crie alguns canais para manipular o stdin/stdout/stderr

Para executar o psexec nós precisamos apenas das credenciais de admin para o remote host e o comando que queremos executar

`psexec64.exe \\MACHINE_IP -u Administrator -p Mypass123 -i cmd.exe`

## WinRM

Windows Remote Management (WinRM) is a web-based protocol used to send Powershell commands to Windows hosts remotely. Most Windows Server installations will have WinRM enabled by default, making it an attractive attack vector.
**Portas 5985/TCP (WinRM HTTP) ; 5986/TCP (WinRM HTTPS)** - **Required Group Memberships** : Remote Management Users

Para conectar de forma remota a uma sessão de power shell podemos utilizar o seguinte comando :

`winrs.exe -u:Administrator -p:Mypass123 -r:target cmd`

## sc

We can create a service on a remote host with sc.exe, a standard tool available in Windows. When using sc, it will try to connect to the Service Control Manager (SVCCTL) remote service program through RPC in several ways.

**Required Group Memberships** : Administrators

**Portas :** 
| Numero | Serviço |
| 135/TCP, 49152-65535/TCP | DCE/RPC |
| 445/TCP | (RPC over SMB Named Pipes) |
| 139/TCP | (RPC over SMB Named Pipes) |

Etapas : 

1. A connection attempt will be made using DCE/RPC. The client will first connect to the Endpoint Mapper (EPM) at port 135, which serves as a catalogue of available RPC endpoints and request information on the SVCCTL service program. The EPM will then respond with the IP and port to connect to SVCCTL, which is usually a dynamic port in the range of 49152-65535.
2. If the latter connection fails, sc will try to reach SVCCTL through SMB named pipes, either on port 445 (SMB) or 139 (SMB over NetBIOS).

### Criando o serviço
`sc.exe \\TARGET create THMservice binPath= "net user munra Pass123 /add" start= auto`
### Start no serviço
`sc.exe \\TARGET start THMservice`
### Stop no serviço
`sc.exe \\TARGET stop THMservice`
### Delete no Serviço
`sc.exe \\TARGET delete THMservice`


## Scheduling Tasks

Another Windows feature we can use is Scheduled Tasks. You can create and run one remotely with schtasks, available in any Windows installation. To create a task named THMtask1, we can use the following commands:

`schtasks /s TARGET /RU "SYSTEM" /create /tn "THMtask1" /tr "<command/payload to execute>" /sc ONCE /sd 01/01/1970 /st 00:00 `

`schtasks /s TARGET /run /TN "THMtask1" `
We set the schedule type (/sc) to ONCE, which means the task is intended to be run only once at the specified time and date. Since we will be running the task manually, the starting date (/sd) and starting time (/st) won't matter much anyway.

Since the system will run the scheduled task, the command's output won't be available to us, making this a blind attack.

Finally, to delete the scheduled task, we can use the following command and clean up after ourselves:

`schtasks /S TARGET /TN "THMtask1" /DELETE /F`